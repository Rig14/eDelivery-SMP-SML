services:
  harmony-ap-sender:
    image: niis/harmony-ap:2.6.0
    ports:
      - "8080:8080"
    environment:
      - DB_HOST=harmony-db-sender
      - DB_PASSWORD=secret
      - ADMIN_PASSWORD=secret
      - USE_DYNAMIC_DISCOVERY=true
      - PARTY_NAME=sender
      - LB_TLS_TERMINATION=true
      - SECURITY_KEYSTORE_PASSWORD=changeit
      - SECURITY_TRUSTSTORE_PASSWORD=changeit
      - TLS_KEYSTORE_PASSWORD=changeit
      - TLS_TRUSTSTORE_PASSWORD=changeit
    restart: unless-stopped
    volumes:
      - ap-data-sender:/var/opt/harmony-ap
    depends_on:
      - harmony-db-sender

  harmony-db-sender:
    image: mysql:8
    command:
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_bin"
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=true
      - MYSQL_DATABASE=harmony_ap
      - MYSQL_USER=harmony_ap
      - MYSQL_PASSWORD=secret
    restart: on-failure
    volumes:
      - ap-db-data-sender:/var/lib/mysql

  harmony-ap-receiver:
    image: niis/harmony-ap:2.6.0
    ports:
      - "8081:8080"
    environment:
      - DB_HOST=harmony-db-receiver
      - DB_PASSWORD=secret
      - ADMIN_PASSWORD=secret
      - USE_DYNAMIC_DISCOVERY=true
      - PARTY_NAME=receiver
      - LB_TLS_TERMINATION=true
      - SECURITY_KEYSTORE_PASSWORD=changeit
      - SECURITY_TRUSTSTORE_PASSWORD=changeit
      - TLS_KEYSTORE_PASSWORD=changeit
      - TLS_TRUSTSTORE_PASSWORD=changeit
    restart: unless-stopped
    volumes:
      - ap-data-receiver:/var/opt/harmony-ap
    depends_on:
      - harmony-db-receiver

  harmony-db-receiver:
    image: mysql:8
    command:
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_bin"
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=true
      - MYSQL_DATABASE=harmony_ap
      - MYSQL_USER=harmony_ap
      - MYSQL_PASSWORD=secret
    restart: on-failure
    volumes:
      - ap-db-data-receiver:/var/lib/mysql

  phoss-smp:
    image: phelger/phoss-smp-xml:latest
    container_name: phoss-smp
    ports:
      - "8090:8080"
    environment:
      - CONFIG_FILE=/config/application.properties
    volumes:
      - ./smp:/config:ro
      - smp-data:/home/git/conf
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  coredns:
    image: coredns/coredns:latest
    container_name: coredns
    command: -conf /etc/coredns/Corefile -dns.port 53
    ports:
      - "5353:53"
      - "5353:53/udp"
      - "8070:8080"
    volumes:
      - ./coredns/Corefile:/etc/coredns/Corefile
      - ./coredns/zone/db.sml.test:/etc/coredns/db.sml.test

volumes:
  ap-data-sender:
  ap-db-data-sender:
  ap-data-receiver:
  ap-db-data-receiver:
  smp-data:
