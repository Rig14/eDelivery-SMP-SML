services:
  coredns:
    image: coredns/coredns:latest
    command: -conf /etc/coredns/Corefile
    environment:
      - SML_ZONE=testsml
    volumes:
      - ./coredns:/etc/coredns
    restart: unless-stopped
    networks:
      harmony-network:
        ipv4_address: 172.20.0.2

  harmony-ap-sender:
    image: niis/harmony-ap:2.6.0
    ports:
      - "8090:8080"
    environment:
      - DB_HOST=harmony-db-sender
      - DB_PASSWORD=secret
      - ADMIN_PASSWORD=secret
      - USE_DYNAMIC_DISCOVERY=true
      - PARTY_NAME=sender
      - LB_TLS_TERMINATION=true
      - SECURITY_KEYSTORE_PASSWORD=changeit
      - SECURITY_TRUSTSTORE_PASSWORD=changeit
      - TLS_KEYSTORE_PASSWORD=changeit
      - TLS_TRUSTSTORE_PASSWORD=changeit
    restart: unless-stopped
    volumes:
      - ap-data-sender:/var/opt/harmony-ap
    depends_on:
      - harmony-db-sender
      - coredns
    dns:
      - 172.20.0.2
    networks:
      - harmony-network

  harmony-db-sender:
    image: mysql:8
    command:
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_bin"
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=true
      - MYSQL_DATABASE=harmony_ap
      - MYSQL_USER=harmony_ap
      - MYSQL_PASSWORD=secret
    restart: on-failure
    volumes:
      - ap-db-data-sender:/var/lib/mysql
    networks:
      - harmony-network

  harmony-ap-receiver:
    image: niis/harmony-ap:2.6.0
    ports:
      - "8091:8080"
    environment:
      - DB_HOST=harmony-db-receiver
      - DB_PASSWORD=secret
      - ADMIN_PASSWORD=secret
      - USE_DYNAMIC_DISCOVERY=true
      - PARTY_NAME=receiver
      - LB_TLS_TERMINATION=true
      - SECURITY_KEYSTORE_PASSWORD=changeit
      - SECURITY_TRUSTSTORE_PASSWORD=changeit
      - TLS_KEYSTORE_PASSWORD=changeit
      - TLS_TRUSTSTORE_PASSWORD=changeit
    restart: unless-stopped
    volumes:
      - ap-data-receiver:/var/opt/harmony-ap
    depends_on:
      - harmony-db-receiver

  harmony-db-receiver:
    image: mysql:8
    command:
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_bin"
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=true
      - MYSQL_DATABASE=harmony_ap
      - MYSQL_USER=harmony_ap
      - MYSQL_PASSWORD=secret
    restart: on-failure
    volumes:
      - ap-db-data-receiver:/var/lib/mysql

  phoss-smp:
    image: phelger/phoss-smp-xml:latest
    container_name: phoss-smp
    ports:
      - "8080:8080"
    environment:
      - CONFIG_FILE=/config/application.properties
    volumes:
      - ./smp:/config:ro
      - smp-data:/home/git/conf
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    command: >
      sh -c "apt-get update && apt-get install -y socat &&
             socat TCP-LISTEN:80,fork TCP:127.0.0.1:8080 &
             catalina.sh run"
    networks:
      harmony-network:
        ipv4_address: 172.20.0.10

volumes:
  ap-data-sender:
  ap-db-data-sender:
  ap-data-receiver:
  ap-db-data-receiver:
  smp-data:

networks:
  harmony-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16